# -*- mode: dockerfile-ts -*-

ARG VERSION=42
ARG USERNAME=benchy
FROM fedora:$VERSION AS fedora-baseline:$VERSION

# Base dependencies.
RUN dnf update -y && dnf install -y \
	git \
	ripgrep \
	rsync \
	htop \
	curl \
	minisign \
	man \
	which \
	lsof \
	acl \
	diffutils \
	just \
    jq \
    bash \
    bsdtar \
	\
	&& dnf clean all

# FROM fedora-baseline:$VERSION as pooped-fedora:$VERSION

# -------------------------------------------- Namespace mapping.
# Without the following magic adduser namespace mapping will break horribly. If you do NOT want to use it one alternative is that the Containerfile must specify no USER at all, and when calling `run` on podman-machine as user `core` `--userns keep-id:uid=501` must be passed.

# UID for this account must match macOS UID that is running podman-machine (vm) as by default Podman will set up namespace mapping to said UID which is also (from macOS) default: 501.
ARG USERNAME
RUN adduser \
	--groups wheel \
	--home-dir /home/"$USERNAME" \
	--password '' \
	--shell /bin/bash \
	--user-group \
	"$USERNAME"
# -------------------------------------------- /

RUN mkdir -p /home/"$USERNAME"/bin

FROM fedora-baseline:$VERSION as benchy-aztec-fedora:$VERSION

# Unless specified will inherit value as set at top of file.
ARG VERSION
ARG USERNAME
ARG PROJECT_NAME=benchy-aztec-barretenberg
ARG HARNESS_LOC

LABEL sh.jam.name="$PROJECT_NAME" \
	  sh.jam.summary="Image with $PROJECT_NAME project dependencies"

ENV JAM_PROJECT="$PROJECT_NAME"
USER $USERNAME

WORKDIR /home/$USERNAME

COPY "$HARNESS_LOC"/benchy_aztec_imaged.sh /home/"$USERNAME"/benchy_imaged.sh
COPY "$HARNESS_LOC"/bootstrap /home/"$USERNAME"/bin
RUN /home/"$USERNAME"/bin/bootstrap

FROM benchy-aztec-fedora:$VERSION

ARG USERNAME
ARG HARNESS_LOC
USER $USERNAME
WORKDIR /home/$USERNAME

# Install aztec packages (circuit benchmark targets).
# RUN git clone https://github.com/AztecProtocol/aztec-packages.git
# cd aztec-packages/noir-projects/noir-protocol-circuits/crates/private-kernel-inner
# /home/jammy/poop/zig-out/bin/poop 'nargo execute'

COPY "$HARNESS_LOC"/aztec /home/"$USERNAME"/bin

# We'll just clone it all for now, do a sparse checkout later.
RUN git clone https://github.com/noir-lang/noir.git

COPY ./harness/install/poop /tmp/install-poop
RUN sudo /tmp/install-poop && sudo chown "$USERNAME":"$USERNAME" /home/"$USERNAME"/bin

# CMD ["/bin/bash", "-l"]

# ls -lan
# ls -la@
# podman top -l capeff
# podman top -l user uid huser group hgroups
